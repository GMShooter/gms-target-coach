# Use Node.js 18 LTS as base image for testing
FROM node:18-alpine

# Set working directory
WORKDIR /app

# Install dependencies
COPY package*.json ./
RUN npm ci

# Copy source code
COPY . .

# Install additional testing dependencies
RUN npm install -g @playwright/test

# Install browser dependencies for Playwright/Cypress
RUN apk add --no-cache \
    chromium \
    nss \
    freetype \
    freetype-dev \
    harfbuzz \
    ca-certificates \
    ttf-freefont

# Set Playwright browsers path
ENV PLAYWRIGHT_BROWSERS_PATH=/ms-playwright

# Install Playwright browsers
RUN npx playwright install chromium

# Create test user
RUN addgroup -g 1001 nodejs
RUN adduser 1001 -G nodejs -s /bin/sh -D nodejs

# Change ownership of the app directory
RUN chown -R 1001:nodejs /app
USER 1001

# Expose port for test server if needed
EXPOSE 3000

# Default command for running tests
CMD ["npm", "run", "test:ci"]